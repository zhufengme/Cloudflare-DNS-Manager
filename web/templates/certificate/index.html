<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Domain}} - SSL/TLS è¯ä¹¦ - Cloudflare DNS Manager</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
    <style>
        .cert-card { margin-bottom: 1rem; }
        .cert-badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
        .days-warning { color: #dc3545; }
        .days-ok { color: #198754; }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline-block; }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/zones">Cloudflare DNS Manager</a>
            <div class="d-flex">
                <a href="/logout" class="btn btn-outline-light btn-sm">é€€å‡º</a>
            </div>
        </div>
    </nav>

<main role="main" class="container my-4">
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{.Domain}} - SSL/TLS è¯ä¹¦ç®¡ç†</h2>
    <a href="/zone?zoneid={{.ZoneID}}&domain={{.Domain}}" class="btn btn-secondary">è¿”å› DNS ç®¡ç†</a>
</div>

{{if .Error}}
<div class="alert alert-danger">{{.Error}}</div>
{{end}}

<div id="message-container"></div>

<!-- æ ‡ç­¾é¡µå¯¼èˆª -->
<ul class="nav nav-tabs" role="tablist">
    <li class="nav-item">
        <a class="nav-link {{if eq .Tab "edge"}}active{{end}}"
           href="/certificates?zoneid={{.ZoneID}}&domain={{.Domain}}&tab=edge">
            è¾¹ç¼˜è¯ä¹¦
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{if eq .Tab "origin"}}active{{end}}"
           href="/certificates?zoneid={{.ZoneID}}&domain={{.Domain}}&tab=origin">
            å›æºè¯ä¹¦
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {{if eq .Tab "custom"}}active{{end}}"
           href="/certificates?zoneid={{.ZoneID}}&domain={{.Domain}}&tab=custom">
            è‡ªå®šä¹‰è¯ä¹¦
        </a>
    </li>
</ul>

<div class="tab-content mt-3">
    <!-- è¾¹ç¼˜è¯ä¹¦æ ‡ç­¾é¡µ -->
    {{if eq .Tab "edge"}}
    <div class="tab-pane fade show active">
        <p class="text-muted">è¾¹ç¼˜è¯ä¹¦ç”± Cloudflare è‡ªåŠ¨ç®¡ç†ï¼Œç”¨äºæµè§ˆå™¨ä¸ Cloudflare ä¹‹é—´çš„ HTTPS è¿æ¥ã€‚</p>

        {{if .EdgeCertificates}}
            {{range .EdgeCertificates}}
            <div class="card cert-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-{{if eq .Type "universal"}}primary{{else if eq .Type "advanced"}}success{{else}}secondary{{end}} cert-badge">
                            {{if eq .Type "universal"}}Universal SSL{{else if eq .Type "advanced"}}Advanced Certificate{{else}}{{.Type}}{{end}}
                        </span>
                        <strong class="ms-2">{{index .Hosts 0}}</strong>
                    </div>
                    <span class="badge bg-{{if eq .Status "active"}}success{{else if eq .Status "pending"}}warning{{else}}secondary{{end}}">
                        {{if eq .Status "active"}}Active{{else if eq .Status "pending"}}Pending{{else}}{{.Status}}{{end}}
                    </span>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>åŸŸåè¦†ç›–:</strong></p>
                            <ul class="list-unstyled">
                                {{range .Hosts}}
                                <li><code>{{.}}</code></li>
                                {{end}}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>é¢å‘æœºæ„:</strong> {{.CertificateAuthority}}</p>
                            <p class="mb-1"><strong>æœ‰æ•ˆæœŸ:</strong> {{.ValidityDays}} å¤©</p>
                            <p class="mb-1"><strong>éªŒè¯æ–¹å¼:</strong> {{.ValidationMethod}}</p>
                            {{if .CloudflareBranding}}
                            <p class="mb-1"><small class="text-muted">åŒ…å« Cloudflare å“ç‰Œ</small></p>
                            {{end}}
                        </div>
                    </div>
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="alert alert-info">æ²¡æœ‰æ‰¾åˆ°è¾¹ç¼˜è¯ä¹¦</div>
        {{end}}
    </div>
    {{end}}

    <!-- å›æºè¯ä¹¦æ ‡ç­¾é¡µ -->
    {{if eq .Tab "origin"}}
    <div class="tab-pane fade show active">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="text-muted mb-0">å›æºè¯ä¹¦ç”¨äº Cloudflare ä¸æ‚¨æºç«™ä¹‹é—´çš„ HTTPS è¿æ¥ï¼Œç”± Cloudflare å…è´¹ç­¾å‘ã€‚</p>
            <button class="btn btn-primary" id="openCreateCertModal">
                åˆ›å»ºæ–°è¯ä¹¦
            </button>
        </div>

        {{if .OriginCertificates}}
            {{range .OriginCertificates}}
            <div class="card cert-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span class="badge bg-info cert-badge">Origin Certificate</span>
                        <strong class="ms-2">{{index .Hostnames 0}}{{if gt (len .Hostnames) 1}} +{{sub (len .Hostnames) 1}}{{end}}</strong>
                    </div>
                    {{if .RevokedAt.IsZero}}
                        <span class="badge bg-success">Active</span>
                    {{else}}
                        <span class="badge bg-danger">Revoked</span>
                    {{end}}
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p class="mb-1"><strong>è¯ä¹¦ ID:</strong> <code>{{.ID}}</code></p>
                            <p class="mb-1"><strong>åŸŸå:</strong></p>
                            <ul class="list-unstyled mb-2">
                                {{range .Hostnames}}
                                <li><code>{{.}}</code></li>
                                {{end}}
                            </ul>
                            <p class="mb-1"><strong>ç±»å‹:</strong> {{.RequestType}}</p>
                        </div>
                        <div class="col-md-6">
                            <p class="mb-1"><strong>åˆ°æœŸæ—¶é—´:</strong> {{.ExpiresOn.Format "2006-01-02 15:04:05"}}</p>
                            <p class="mb-1">
                                <strong>å‰©ä½™å¤©æ•°:</strong>
                                {{$days := daysUntil .ExpiresOn}}
                                {{if gt $days 365}}
                                    <span class="badge bg-success">{{$days}} å¤©</span>
                                {{else if gt $days 30}}
                                    <span class="badge bg-warning">{{$days}} å¤©</span>
                                {{else}}
                                    <span class="badge bg-danger">{{$days}} å¤©</span>
                                {{end}}
                            </p>
                            {{if not .RevokedAt.IsZero}}
                            <p class="mb-1"><strong>æ’¤é”€æ—¶é—´:</strong> {{.RevokedAt.Format "2006-01-02 15:04:05"}}</p>
                            {{end}}
                        </div>
                    </div>
                    <div class="mt-2">
                        <a href="/api/certificates/origin/{{.ID}}/download" class="btn btn-sm btn-success">
                            ä¸‹è½½è¯ä¹¦ (.pem)
                        </a>
                        <button class="btn btn-sm btn-outline-primary view-stored-key-btn"
                                data-cert-id="{{.ID}}"
                                onclick="openViewKeyModal('{{.ID}}')"
                                style="display: none;">
                            ğŸ”‘ æŸ¥çœ‹ç§é’¥
                        </button>
                        {{if .RevokedAt.IsZero}}
                        <button class="btn btn-sm btn-danger"
                                hx-post="/api/certificates/origin/{{.ID}}/revoke"
                                hx-confirm="ç¡®å®šè¦æ’¤é”€æ­¤è¯ä¹¦å—ï¼Ÿæ’¤é”€åæ— æ³•æ¢å¤ï¼"
                                hx-swap="none"
                                hx-on::after-request="if(event.detail.successful) {
                                    showMessage('è¯ä¹¦å·²æ’¤é”€', 'success');
                                    setTimeout(() => window.location.reload(), 1500);
                                } else {
                                    showMessage('æ’¤é”€å¤±è´¥', 'danger');
                                }">
                            æ’¤é”€è¯ä¹¦
                        </button>
                        {{end}}
                    </div>
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="alert alert-info">
                è¿˜æ²¡æœ‰å›æºè¯ä¹¦ã€‚<button class="btn btn-link p-0" id="openCreateCertModalEmpty">åˆ›å»ºç¬¬ä¸€ä¸ªè¯ä¹¦</button>
            </div>
        {{end}}
    </div>
    {{end}}

    <!-- è‡ªå®šä¹‰è¯ä¹¦æ ‡ç­¾é¡µ -->
    {{if eq .Tab "custom"}}
    <div class="tab-pane fade show active">
        <p class="text-muted">è‡ªå®šä¹‰è¯ä¹¦å…è®¸æ‚¨ä¸Šä¼ è‡ªå·±çš„ SSL è¯ä¹¦ï¼ˆéœ€è¦ Business åŠä»¥ä¸Šå¥—é¤ï¼‰ã€‚</p>

        {{if .CustomCertificates}}
            {{range .CustomCertificates}}
            <div class="card cert-card">
                <div class="card-header">
                    <span class="badge bg-secondary cert-badge">Custom SSL</span>
                    <strong class="ms-2">{{index .Hosts 0}}</strong>
                </div>
                <div class="card-body">
                    <p class="mb-1"><strong>è¯ä¹¦ ID:</strong> <code>{{.ID}}</code></p>
                    <p class="mb-1"><strong>åŸŸå:</strong> {{range .Hosts}}{{.}} {{end}}</p>
                    <p class="mb-1"><strong>é¢å‘è€…:</strong> {{.Issuer}}</p>
                    <p class="mb-1"><strong>åˆ°æœŸæ—¶é—´:</strong> {{.ExpiresOn}}</p>
                </div>
            </div>
            {{end}}
        {{else}}
            <div class="alert alert-info">æ²¡æœ‰è‡ªå®šä¹‰è¯ä¹¦ï¼ˆæ­¤åŠŸèƒ½éœ€è¦ Business åŠä»¥ä¸Šå¥—é¤ï¼‰</div>
        {{end}}
    </div>
    {{end}}
</div>

</main>

<!-- åˆ›å»ºå›æºè¯ä¹¦æ¨¡æ€æ¡† -->
<div class="modal fade" id="createOriginCertModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">åˆ›å»ºå›æºè¯ä¹¦</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="createCertForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">åŸŸå/ä¸»æœºå <span class="text-danger">*</span></label>
                        <input type="text" name="hostnames" class="form-control"
                               placeholder="{{.Domain}}, *.{{.Domain}} (å¤šä¸ªç”¨é€—å·åˆ†éš”)" required>
                        <small class="text-muted d-block mb-1">
                            <strong>ç¤ºä¾‹ï¼š</strong>{{.Domain}}, *.{{.Domain}}, www.{{.Domain}}
                        </small>
                        <small class="text-warning d-block">
                            âš ï¸ è¯·è¾“å…¥å½“å‰åŸŸå <strong>{{.Domain}}</strong> æˆ–å…¶å­åŸŸåï¼Œä¸èƒ½ä½¿ç”¨å…¶ä»–åŸŸå
                        </small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">è¯ä¹¦ç±»å‹ <span class="text-danger">*</span></label>
                        <select name="request_type" class="form-select" required>
                            <option value="origin-rsa">RSA 2048 (æ¨è)</option>
                            <option value="origin-ecc">ECC</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">æœ‰æ•ˆæœŸ <span class="text-danger">*</span></label>
                        <select name="requested_validity" class="form-select" required>
                            <option value="7">7 å¤©ï¼ˆæµ‹è¯•ï¼‰</option>
                            <option value="30">30 å¤©</option>
                            <option value="90">90 å¤©</option>
                            <option value="365">1 å¹´</option>
                            <option value="1825">5 å¹´</option>
                            <option value="5475" selected>15 å¹´ï¼ˆæ¨èï¼‰</option>
                        </select>
                        <small class="text-muted">æ¨èé€‰æ‹© 15 å¹´ï¼Œå…è´¹ä¸”æ— éœ€é¢‘ç¹æ›´æ–°</small>
                    </div>

                    <div class="alert alert-info mb-0">
                        <strong>æç¤ºï¼š</strong>
                        <ul class="mb-0">
                            <li>åˆ›å»ºåå°†è‡ªåŠ¨ç”Ÿæˆç§é’¥å’Œè¯ä¹¦</li>
                            <li>è¯·å¦¥å–„ä¿å­˜ä¸‹è½½çš„è¯ä¹¦æ–‡ä»¶</li>
                            <li>è¯ä¹¦ç”¨äº Cloudflare ä¸æºç«™ä¹‹é—´çš„åŠ å¯†è¿æ¥</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-primary">
                        <span class="htmx-indicator spinner-border spinner-border-sm"></span>
                        åˆ›å»ºè¯ä¹¦
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- è¯ä¹¦åˆ›å»ºæˆåŠŸæ¨¡æ€æ¡† -->
<div class="modal fade" id="certResultModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">âœ… è¯ä¹¦åˆ›å»ºæˆåŠŸ</h5>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <strong>âš ï¸ é‡è¦æç¤ºï¼š</strong>ç§é’¥åªä¼šæ˜¾ç¤ºä¸€æ¬¡ï¼è¯·ç«‹å³ä¿å­˜ï¼Œå…³é—­åå°†æ— æ³•å†æ¬¡æŸ¥çœ‹ã€‚
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>è¯ä¹¦ ID:</strong></label>
                    <input type="text" id="result-cert-id" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>åŸŸå:</strong></label>
                    <input type="text" id="result-hostnames" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>åˆ°æœŸæ—¶é—´:</strong></label>
                    <input type="text" id="result-expires" class="form-control" readonly>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>è¯ä¹¦ (Certificate):</strong></label>
                    <textarea id="result-certificate" class="form-control font-monospace" rows="10" readonly></textarea>
                    <button class="btn btn-sm btn-success mt-2" onclick="downloadCertificate()">
                        ğŸ’¾ ä¸‹è½½è¯ä¹¦ (certificate.pem)
                    </button>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="copyCertificate()">
                        ğŸ“‹ å¤åˆ¶è¯ä¹¦
                    </button>
                </div>

                <div class="mb-3">
                    <label class="form-label"><strong>ç§é’¥ (Private Key):</strong></label>
                    <textarea id="result-private-key" class="form-control font-monospace" rows="10" readonly></textarea>
                    <button class="btn btn-sm btn-success mt-2" onclick="downloadPrivateKey()">
                        ğŸ’¾ ä¸‹è½½ç§é’¥ (private.key)
                    </button>
                    <button class="btn btn-sm btn-secondary mt-2" onclick="copyPrivateKey()">
                        ğŸ“‹ å¤åˆ¶ç§é’¥
                    </button>
                </div>

                <!-- ä¿å­˜åˆ°æµè§ˆå™¨é€‰é¡¹ -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <div class="form-check mb-2">
                            <input type="checkbox" class="form-check-input" id="saveToLocalStorage" checked>
                            <label class="form-check-label" for="saveToLocalStorage">
                                <strong>ğŸ” ä¿å­˜ç§é’¥åˆ°æµè§ˆå™¨ï¼ˆæ–¹ä¾¿å¤šæ¬¡éƒ¨ç½²æ—¶æŸ¥çœ‹ï¼‰</strong>
                            </label>
                        </div>

                        <div class="alert alert-warning mb-0" style="font-size: 0.9rem;">
                            <p class="mb-2"><strong>å­˜å‚¨ä½ç½®ï¼š</strong>ç§é’¥å°†åŠ å¯†å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ (localStorage) ä¸­ã€‚</p>

                            <p class="mb-2"><strong>åŠ å¯†æœºåˆ¶ï¼š</strong></p>
                            <ul class="mb-2">
                                <li>ä½¿ç”¨æ‚¨çš„ Cloudflare API Key ä½œä¸ºåŠ å¯†å¯†ç </li>
                                <li>é‡‡ç”¨ AES-256-GCM åŠ å¯†ç®—æ³•ï¼ˆé“¶è¡Œçº§åˆ«åŠ å¯†æ ‡å‡†ï¼‰</li>
                                <li>æ¯ä¸ªç§é’¥ä½¿ç”¨ç‹¬ç«‹çš„éšæœºç›å€¼ï¼Œé˜²æ­¢å½©è™¹è¡¨æ”»å‡»</li>
                                <li>æŸ¥çœ‹æ—¶éœ€è¦è¾“å…¥æ­£ç¡®çš„ API Key æ‰èƒ½è§£å¯†</li>
                            </ul>

                            <p class="mb-2"><strong>âš ï¸ é‡è¦é™åˆ¶ï¼š</strong></p>
                            <ul class="mb-2">
                                <li><strong>è®¾å¤‡ç»‘å®š</strong>ï¼šç§é’¥ä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨ä¸­ï¼Œæ›´æ¢ç”µè„‘æˆ–æµè§ˆå™¨å°†æ— æ³•è®¿é—®</li>
                                <li><strong>æ•°æ®æ¸…é™¤</strong>ï¼šæ¸…ç©ºæµè§ˆå™¨æ•°æ®ã€ç¼“å­˜æˆ–ä½¿ç”¨éšç§æ¨¡å¼ä¼šæ°¸ä¹…ä¸¢å¤±å­˜å‚¨çš„ç§é’¥</li>
                                <li><strong>API Key ç»‘å®š</strong>ï¼šå¦‚æœæ‚¨æ›´æ¢äº† Cloudflare API Keyï¼Œå°†æ— æ³•è§£å¯†ä¹‹å‰å­˜å‚¨çš„ç§é’¥</li>
                                <li><strong>æ— äº‘åŒæ­¥</strong>ï¼šä¸åŒè®¾å¤‡ä¹‹é—´ä¸ä¼šè‡ªåŠ¨åŒæ­¥</li>
                            </ul>

                            <p class="mb-0"><strong>ğŸ’¡ å»ºè®®ï¼š</strong>åŒæ—¶ä¸‹è½½ç§é’¥æ–‡ä»¶ä½œä¸ºå¤‡ä»½ï¼Œå­˜å‚¨åœ¨å®‰å…¨çš„ä½ç½®ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" id="confirmSaveBtn" onclick="confirmAndClose()">
                    ç¡®è®¤å·²ä¿å­˜ï¼Œå…³é—­å¹¶åˆ·æ–°
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æŸ¥çœ‹å·²ä¿å­˜ç§é’¥æ¨¡æ€æ¡† -->
<div class="modal fade" id="viewPrivateKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ”‘ æŸ¥çœ‹å·²ä¿å­˜çš„ç§é’¥</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- API Key è¾“å…¥åŒºåŸŸ -->
                <div id="apiKeyInputSection">
                    <div class="alert alert-info">
                        <strong>è¯´æ˜ï¼š</strong>ç§é’¥å·²ä½¿ç”¨æ‚¨çš„ Cloudflare API Key åŠ å¯†å­˜å‚¨ã€‚è¯·è¾“å…¥æ‚¨çš„ API Key ä»¥è§£å¯†æŸ¥çœ‹ã€‚
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>è¯ä¹¦ä¿¡æ¯ï¼š</strong></label>
                        <div id="storedCertInfo" class="bg-light p-2 rounded">
                            <p class="mb-1"><strong>è¯ä¹¦ ID:</strong> <code id="view-cert-id"></code></p>
                            <p class="mb-1"><strong>åŸŸå:</strong> <span id="view-hostnames"></span></p>
                            <p class="mb-0"><strong>ä¿å­˜æ—¶é—´:</strong> <span id="view-stored-at"></span></p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>Cloudflare API Key</strong></label>
                        <input type="password" id="decryptApiKey" class="form-control"
                               placeholder="è¾“å…¥æ‚¨çš„ Global API Key">
                        <small class="text-muted">ä¸åˆ›å»ºè¯ä¹¦æ—¶ä½¿ç”¨çš„ API Key ç›¸åŒ</small>
                    </div>
                    <button class="btn btn-primary" onclick="decryptAndShowKey()">
                        ğŸ”“ è§£å¯†ç§é’¥
                    </button>
                </div>

                <!-- è§£å¯†åçš„ç§é’¥æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="decryptedKeySection" style="display: none;">
                    <div class="alert alert-success">
                        <strong>âœ… è§£å¯†æˆåŠŸï¼</strong>ç§é’¥å·²æ˜¾ç¤ºåœ¨ä¸‹æ–¹ã€‚
                    </div>

                    <div class="mb-3">
                        <label class="form-label"><strong>ç§é’¥ (Private Key):</strong></label>
                        <textarea id="decrypted-private-key" class="form-control font-monospace"
                                  rows="12" readonly></textarea>
                    </div>
                    <button class="btn btn-sm btn-success" onclick="downloadDecryptedKey()">
                        ğŸ’¾ ä¸‹è½½ç§é’¥
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="copyDecryptedKey()">
                        ğŸ“‹ å¤åˆ¶ç§é’¥
                    </button>
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="deleteStoredKey()">
                        ğŸ—‘ï¸ ä»æµè§ˆå™¨åˆ é™¤
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
            </div>
        </div>
    </div>
</div>

<script src="/static/js/htmx.min.js"></script>
<script src="/static/js/bootstrap.bundle.min.js"></script>
<script>
    // ============================================
    // å…¨å±€å˜é‡å£°æ˜
    // ============================================
    let pendingCertData = null;
    let resultModalInstance = null;
    let currentViewCertId = null;

    // æ£€æŸ¥ Web Crypto API æ˜¯å¦å¯ç”¨
    const isCryptoAvailable = !!(window.crypto && window.crypto.subtle);
    if (!isCryptoAvailable) {
        console.error('[ERROR] Web Crypto API ä¸å¯ç”¨ã€‚éœ€è¦ HTTPS æˆ– localhost è®¿é—®ã€‚');
    }

    // ============================================
    // ç§é’¥æœ¬åœ°åŠ å¯†å­˜å‚¨åŠŸèƒ½
    // ============================================
    const STORAGE_KEY = "cf_origin_cert_keys";

    // PBKDF2 å¯†é’¥æ´¾ç”Ÿå‡½æ•°
    async function deriveEncryptionKey(apiKey, salt) {
        if (!isCryptoAvailable) {
            throw new Error('Web Crypto API ä¸å¯ç”¨ï¼Œéœ€è¦é€šè¿‡ HTTPS è®¿é—®');
        }
        const keyMaterial = await crypto.subtle.importKey(
            "raw",
            new TextEncoder().encode(apiKey),
            "PBKDF2",
            false,
            ["deriveKey"]
        );

        return await crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
        );
    }

    // ============================================
    // åŠ å¯†/è§£å¯†å‡½æ•°ï¼ˆæ”¯æŒ HTTPS å’Œ HTTP ä¸¤ç§æ¨¡å¼ï¼‰
    // ============================================

    // ç®€å• XOR æ··æ·†å‡½æ•°ï¼ˆHTTP æ¨¡å¼å¤‡ç”¨ï¼‰
    function xorEncrypt(text, key) {
        let result = '';
        for (let i = 0; i < text.length; i++) {
            result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return btoa(result);
    }

    function xorDecrypt(encoded, key) {
        const text = atob(encoded);
        let result = '';
        for (let i = 0; i < text.length; i++) {
            result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
        }
        return result;
    }

    // åŠ å¯†ç§é’¥ï¼ˆè‡ªåŠ¨é€‰æ‹©åŠ å¯†æ¨¡å¼ï¼‰
    async function encryptPrivateKey(privateKey, apiKey) {
        if (isCryptoAvailable) {
            // HTTPS æ¨¡å¼ï¼šä½¿ç”¨ AES-GCM
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const iv = crypto.getRandomValues(new Uint8Array(12));

            const encryptionKey = await deriveEncryptionKey(apiKey, salt);
            const encodedPrivateKey = new TextEncoder().encode(privateKey);

            const ciphertext = await crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                encryptionKey,
                encodedPrivateKey
            );

            return {
                encryptedKey: btoa(String.fromCharCode(...new Uint8Array(ciphertext))),
                iv: btoa(String.fromCharCode(...iv)),
                salt: btoa(String.fromCharCode(...salt)),
                mode: 'aes-gcm'
            };
        } else {
            // HTTP æ¨¡å¼ï¼šä½¿ç”¨ç®€å• XOR æ··æ·†
            console.warn('[WARN] ä½¿ç”¨ HTTP æ¨¡å¼ï¼ŒåŠ å¯†å¼ºåº¦è¾ƒä½ã€‚å»ºè®®ä½¿ç”¨ HTTPSã€‚');
            return {
                encryptedKey: xorEncrypt(privateKey, apiKey),
                mode: 'xor'
            };
        }
    }

    // è§£å¯†ç§é’¥ï¼ˆè‡ªåŠ¨é€‰æ‹©è§£å¯†æ¨¡å¼ï¼‰
    async function decryptPrivateKey(encryptedData, apiKey) {
        if (encryptedData.mode === 'xor') {
            // XOR æ¨¡å¼è§£å¯†
            return xorDecrypt(encryptedData.encryptedKey, apiKey);
        } else {
            // AES-GCM æ¨¡å¼è§£å¯†
            if (!isCryptoAvailable) {
                throw new Error('æ­¤ç§é’¥ä½¿ç”¨ AES-GCM åŠ å¯†ï¼Œéœ€è¦é€šè¿‡ HTTPS è®¿é—®æ‰èƒ½è§£å¯†');
            }

            const ciphertext = Uint8Array.from(atob(encryptedData.encryptedKey), c => c.charCodeAt(0));
            const iv = Uint8Array.from(atob(encryptedData.iv), c => c.charCodeAt(0));
            const salt = Uint8Array.from(atob(encryptedData.salt), c => c.charCodeAt(0));

            const decryptionKey = await deriveEncryptionKey(apiKey, salt);

            const decrypted = await crypto.subtle.decrypt(
                { name: "AES-GCM", iv: iv },
                decryptionKey,
                ciphertext
            );

            return new TextDecoder().decode(decrypted);
        }
    }

    // ============================================
    // localStorage ç®¡ç†å‡½æ•°
    // ============================================

    // è·å–æ‰€æœ‰å­˜å‚¨çš„è¯ä¹¦ç§é’¥
    function getStoredCertificates() {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : {};
    }

    // ä¿å­˜è¯ä¹¦ç§é’¥
    function saveCertificateKey(certId, encryptedData, metadata) {
        const certs = getStoredCertificates();
        certs[certId] = {
            ...encryptedData,
            ...metadata,
            storedAt: new Date().toISOString()
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(certs));
        updateStoredKeysUI();
    }

    // åˆ é™¤è¯ä¹¦ç§é’¥
    function deleteCertificateKey(certId) {
        const certs = getStoredCertificates();
        delete certs[certId];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(certs));
        updateStoredKeysUI();
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨çš„ç§é’¥
    function hasCertificateKey(certId) {
        const certs = getStoredCertificates();
        return certId in certs;
    }

    // æ›´æ–°UIçŠ¶æ€ - æ˜¾ç¤º/éšè—æŸ¥çœ‹ç§é’¥æŒ‰é’®
    function updateStoredKeysUI() {
        document.querySelectorAll('.view-stored-key-btn').forEach(btn => {
            const certId = btn.dataset.certId;
            btn.style.display = hasCertificateKey(certId) ? 'inline-block' : 'none';
        });
    }

    // ============================================
    // åŸæœ‰ä»£ç 
    // ============================================

    // ä¿å­˜æ¨¡æ€æ¡†å®ä¾‹ä»¥ä¾¿åç»­å…³é—­
    var createCertModal = null;

    // æ‰“å¼€åˆ›å»ºè¯ä¹¦æ¨¡æ€æ¡†
    function openCreateModal() {
        const modal = document.getElementById('createOriginCertModal');
        if (modal && typeof bootstrap !== 'undefined') {
            createCertModal = new bootstrap.Modal(modal);
            createCertModal.show();
        } else {
            console.error('[ERROR] Modal element or Bootstrap not found');
            alert('é¡µé¢åŠ è½½ä¸å®Œæ•´ï¼Œè¯·åˆ·æ–°é¡µé¢åé‡è¯•');
        }
    }

    // å…³é—­åˆ›å»ºè¯ä¹¦æ¨¡æ€æ¡†
    function closeCreateModal() {
        if (createCertModal) {
            createCertModal.hide();
        }
    }

    // é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
    document.addEventListener('DOMContentLoaded', function() {
        // ç»‘å®š"åˆ›å»ºæ–°è¯ä¹¦"æŒ‰é’®
        const createBtn = document.getElementById('openCreateCertModal');
        if (createBtn) {
            createBtn.addEventListener('click', openCreateModal);
        }

        // ç»‘å®š"åˆ›å»ºç¬¬ä¸€ä¸ªè¯ä¹¦"æŒ‰é’®
        const createBtnEmpty = document.getElementById('openCreateCertModalEmpty');
        if (createBtnEmpty) {
            createBtnEmpty.addEventListener('click', openCreateModal);
        }
    });

    function showMessage(message, type) {
        const container = document.getElementById('message-container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        container.appendChild(alert);

        setTimeout(() => {
            alert.remove();
        }, 3000);
    }

    // Helper function for daysUntil
    function daysUntil(dateStr) {
        const targetDate = new Date(dateStr);
        const now = new Date();
        const diffTime = targetDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays;
    }

    // åˆ›å»ºè¯ä¹¦è¡¨å•æäº¤
    document.getElementById('createCertForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.querySelector('.htmx-indicator').style.display = 'inline-block';

        fetch('/api/certificates/origin/create?zoneid={{.ZoneID}}', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'  // æºå¸¦ cookies
        })
        .then(response => {
            if (response.status === 401) {
                // ä¼šè¯è¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                alert('ä¼šè¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                window.location.href = '/login';
                return null;
            }
            return response.json();
        })
        .then(data => {
            if (!data) return; // 401 è·³è½¬ï¼Œä¸å¤„ç†

            if (data.success) {
                // å…³é—­åˆ›å»ºæ¨¡æ€æ¡†
                closeCreateModal();

                // æ˜¾ç¤ºè¯ä¹¦å’Œç§é’¥
                showCertificateResult(data);
            } else {
                showMessage(data.error || 'åˆ›å»ºå¤±è´¥', 'danger');
                submitBtn.disabled = false;
                submitBtn.querySelector('.htmx-indicator').style.display = 'none';
            }
        })
        .catch(error => {
            showMessage('åˆ›å»ºå¤±è´¥: ' + error, 'danger');
            submitBtn.disabled = false;
            submitBtn.querySelector('.htmx-indicator').style.display = 'none';
        });
    });

    // æ˜¾ç¤ºè¯ä¹¦åˆ›å»ºç»“æœ
    function showCertificateResult(data) {
        // å­˜å‚¨å¾…ä¿å­˜çš„æ•°æ®ï¼ˆåŒ…å« encryption_keyï¼‰
        pendingCertData = data;
        console.log('[DEBUG] showCertificateResult called, encryption_key:', data.encryption_key ? 'present' : 'missing');

        document.getElementById('result-cert-id').value = data.cert_id;
        document.getElementById('result-hostnames').value = data.hostnames.join(', ');
        document.getElementById('result-expires').value = data.expires_on;
        document.getElementById('result-certificate').value = data.certificate;
        document.getElementById('result-private-key').value = data.private_key;

        // æ˜¾ç¤ºç»“æœæ¨¡æ€æ¡†
        resultModalInstance = new bootstrap.Modal(document.getElementById('certResultModal'));
        resultModalInstance.show();
    }

    // ä¸‹è½½è¯ä¹¦
    function downloadCertificate() {
        const cert = document.getElementById('result-certificate').value;
        const certId = document.getElementById('result-cert-id').value;
        downloadFile(cert, `certificate-${certId.substring(0, 8)}.pem`);
    }

    // ä¸‹è½½ç§é’¥
    function downloadPrivateKey() {
        const key = document.getElementById('result-private-key').value;
        const certId = document.getElementById('result-cert-id').value;
        downloadFile(key, `private-key-${certId.substring(0, 8)}.key`);
    }

    // å¤åˆ¶è¯ä¹¦
    function copyCertificate() {
        const cert = document.getElementById('result-certificate');
        cert.select();
        document.execCommand('copy');
        showMessage('è¯ä¹¦å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // å¤åˆ¶ç§é’¥
    function copyPrivateKey() {
        const key = document.getElementById('result-private-key');
        key.select();
        document.execCommand('copy');
        showMessage('ç§é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // é€šç”¨ä¸‹è½½å‡½æ•°
    function downloadFile(content, filename) {
        const blob = new Blob([content], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showMessage(`å·²ä¸‹è½½: ${filename}`, 'success');
    }

    // ============================================
    // ç§é’¥æœ¬åœ°å­˜å‚¨äº¤äº’é€»è¾‘
    // ============================================

    // æ‰“å¼€æŸ¥çœ‹ç§é’¥æ¨¡æ€æ¡†
    function openViewKeyModal(certId) {
        currentViewCertId = certId;
        const certs = getStoredCertificates();
        const certData = certs[certId];

        if (!certData) {
            showMessage('æœªæ‰¾åˆ°å­˜å‚¨çš„ç§é’¥', 'danger');
            return;
        }

        // å¡«å……è¯ä¹¦ä¿¡æ¯
        document.getElementById('view-cert-id').textContent = certId.substring(0, 16) + '...';
        document.getElementById('view-hostnames').textContent = certData.hostnames ? certData.hostnames.join(', ') : 'æœªçŸ¥';
        document.getElementById('view-stored-at').textContent = certData.storedAt ?
            new Date(certData.storedAt).toLocaleString('zh-CN') : 'æœªçŸ¥';

        // é‡ç½®æ˜¾ç¤ºçŠ¶æ€
        document.getElementById('decryptApiKey').value = '';
        document.getElementById('decrypted-private-key').value = '';
        document.getElementById('apiKeyInputSection').style.display = 'block';
        document.getElementById('decryptedKeySection').style.display = 'none';

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('viewPrivateKeyModal'));
        modal.show();
    }

    // éªŒè¯ç§é’¥æ ¼å¼æ˜¯å¦æ­£ç¡®
    function isValidPrivateKey(key) {
        if (!key || typeof key !== 'string') return false;
        // æ£€æŸ¥ PEM æ ¼å¼ï¼šä»¥ -----BEGIN å¼€å¤´ï¼Œä»¥ -----END ç»“å°¾
        const trimmed = key.trim();
        const isRSA = trimmed.startsWith('-----BEGIN RSA PRIVATE KEY-----') &&
                      trimmed.endsWith('-----END RSA PRIVATE KEY-----');
        const isEC = trimmed.startsWith('-----BEGIN EC PRIVATE KEY-----') &&
                     trimmed.endsWith('-----END EC PRIVATE KEY-----');
        const isGeneric = trimmed.startsWith('-----BEGIN PRIVATE KEY-----') &&
                          trimmed.endsWith('-----END PRIVATE KEY-----');
        return isRSA || isEC || isGeneric;
    }

    // è§£å¯†å¹¶æ˜¾ç¤ºç§é’¥
    async function decryptAndShowKey() {
        const apiKey = document.getElementById('decryptApiKey').value.trim();
        if (!apiKey) {
            showMessage('è¯·è¾“å…¥ API Key', 'warning');
            return;
        }

        const certs = getStoredCertificates();
        const certData = certs[currentViewCertId];

        if (!certData) {
            showMessage('æœªæ‰¾åˆ°å­˜å‚¨çš„ç§é’¥', 'danger');
            return;
        }

        try {
            const decrypted = await decryptPrivateKey(certData, apiKey);

            // éªŒè¯è§£å¯†åçš„ç§é’¥æ ¼å¼
            if (!isValidPrivateKey(decrypted)) {
                showMessage('API Key ä¸æ­£ç¡®ï¼Œæ— æ³•è§£å¯†ç§é’¥', 'danger');
                return;
            }

            document.getElementById('decrypted-private-key').value = decrypted;
            document.getElementById('apiKeyInputSection').style.display = 'none';
            document.getElementById('decryptedKeySection').style.display = 'block';
            // æ¸…é™¤API Keyè¾“å…¥
            document.getElementById('decryptApiKey').value = '';
        } catch (error) {
            console.error('Decryption failed:', error);
            showMessage('è§£å¯†å¤±è´¥ï¼šAPI Key å¯èƒ½ä¸æ­£ç¡®', 'danger');
        }
    }

    // ä¸‹è½½è§£å¯†åçš„ç§é’¥
    function downloadDecryptedKey() {
        const key = document.getElementById('decrypted-private-key').value;
        downloadFile(key, `private-key-${currentViewCertId.substring(0, 8)}.key`);
    }

    // å¤åˆ¶è§£å¯†åçš„ç§é’¥
    function copyDecryptedKey() {
        const keyEl = document.getElementById('decrypted-private-key');
        keyEl.select();
        document.execCommand('copy');
        showMessage('ç§é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }

    // åˆ é™¤å­˜å‚¨çš„ç§é’¥
    function deleteStoredKey() {
        if (confirm('ç¡®å®šè¦ä»æµè§ˆå™¨åˆ é™¤æ­¤ç§é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
            deleteCertificateKey(currentViewCertId);
            bootstrap.Modal.getInstance(document.getElementById('viewPrivateKeyModal')).hide();
            showMessage('ç§é’¥å·²ä»æµè§ˆå™¨åˆ é™¤', 'success');
        }
    }

    // ç¡®è®¤å¹¶å…³é—­ç»“æœæ¨¡æ€æ¡†
    async function confirmAndClose() {
        console.log('[DEBUG] confirmAndClose called');
        console.log('[DEBUG] pendingCertData:', pendingCertData);

        const saveCheckbox = document.getElementById('saveToLocalStorage');
        console.log('[DEBUG] saveCheckbox checked:', saveCheckbox ? saveCheckbox.checked : 'not found');
        console.log('[DEBUG] encryption_key present:', pendingCertData ? !!pendingCertData.encryption_key : false);

        if (saveCheckbox && saveCheckbox.checked && pendingCertData && pendingCertData.encryption_key) {
            try {
                console.log('[DEBUG] Starting encryption...');
                // ä½¿ç”¨åç«¯è¿”å›çš„ encryption_key ç›´æ¥åŠ å¯†ä¿å­˜
                const encrypted = await encryptPrivateKey(pendingCertData.private_key, pendingCertData.encryption_key);
                console.log('[DEBUG] Encryption successful, saving to localStorage...');
                saveCertificateKey(pendingCertData.cert_id, encrypted, {
                    hostnames: pendingCertData.hostnames,
                    expiresOn: pendingCertData.expires_on
                });
                console.log('[DEBUG] Saved to localStorage, cert_id:', pendingCertData.cert_id);
                showMessage('ç§é’¥å·²åŠ å¯†ä¿å­˜åˆ°æµè§ˆå™¨', 'success');
            } catch (error) {
                console.error('[DEBUG] Save failed:', error);
                showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'danger');
            }
        } else {
            console.log('[DEBUG] Skipping save - conditions not met');
        }

        pendingCertData = null;

        // å»¶è¿Ÿåˆ·æ–°ä»¥æ˜¾ç¤ºæ¶ˆæ¯
        setTimeout(() => {
            window.location.reload();
        }, 800);
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // æ›´æ–°å­˜å‚¨çš„ç§é’¥æŒ‰é’®çŠ¶æ€
        updateStoredKeysUI();
        console.log('[DEBUG] Page loaded, stored certificates:', Object.keys(getStoredCertificates()));
    });
</script>
</body>
</html>
